/*
 * Fancy Product Designer v1.0
 *
 * Copyright 2011, Rafael Dery
 *
 */
 
(function(g){function q(){var m=document.URL,j=m.indexOf("://")+3,f=m.indexOf("/",j);m=m.substring(j,f);j=m.lastIndexOf(".")-1;j=m.lastIndexOf(".",j)+1;m=m.substring(j,m.length);for(f=j=0;f<m.length;++f){var r=m.charAt(f);j+=r.charCodeAt(0)}return j!=991&&j!=1109&&m!=""?true:false}var N=function(m,j){var f=g.extend({},g.fn.fancyProductDesigner.defaults,j),r=this,i,E,k,F,w,n,x,z,y,t,G,Q=0,M=-1,c=null,A=0,H=false,I=false,J=false,B=false,K="Helvetica",u={tb:8,lr:5};parameters={x:0,y:0,colors:false,removable:false,
draggable:false,rotatable:false,resizable:false,scale:1,degree:0,price:0,boundingBox:false};if(q())return false;i=g(m).addClass("fpd-container clearfix");y=i.children(".fpd-product").remove();t=i.children(".fpd-motive").children("img, span");z=document.createElement("canvas");if(!Boolean(z.getContext&&z.getContext("2d"))){i.append('<div class="fpd-browser-alert"><p>'+f.canvasAlert+"</p></div>").children("div").append('<span><a href="http://www.mozilla.org/firefox/new/" title="Download Firefox" class="firefox"></a><a href="http://www.google.com/Chrome" title="Download Chrome" class="chrome"></a><a href="http://www.opera.com/download/" title="Download Opera" class="opera"></a></span>');
i.trigger("canvasFail");return false}if(y.size()>1)E=i.append('<div class="fpd-product-selection"><a href="#" class="fpd-scroll-up ui-state-default"><span class="ui-icon ui-icon-carat-1-n"></span></a><div><ul></ul></div><a href="#" class="fpd-scroll-down ui-state-default"><span class="ui-icon ui-icon-carat-1-s"></span></a></div>').children(".fpd-product-selection").find("ul");k=i.append('<div class="fpd-product-container"><div><div class="fpd-toolbar"></div></div><section class="clearfix"></section></div>').children(".fpd-product-container").children("div");
if(t.size()>0){F=i.append('<div class="fpd-motive-selection"><a href="#" class="fpd-scroll-up ui-state-default"><span class="ui-icon ui-icon-carat-1-n"></span></a><div><ul class="clearfix"></ul></div><a href="#" class="fpd-scroll-down ui-state-default"><span class="ui-icon ui-icon-carat-1-s"></span></a></div>').children(".fpd-motive-selection").find("ul");t.parent().remove()}w=k.children(".fpd-toolbar").append('<div class="fpd-color-picker clearfix"><ul></ul><span class="fpd-current-color"></span><input type="text" value="" disabled="disabled" /></div><select class="fpd-fonts-dropdown"></select><div class="fpd-reset ui-state-default" title="Reset"><span class="ui-icon ui-icon-refresh"></span></div><div class="fpd-deselect ui-state-default" title="Deselect"><span class="ui-icon ui-icon-closethick"></span></div>');
z=k.parent().children("section");if(q())return false;this.getProduct=function(a){onlyEditableElemets=typeof a!=="undefined"?a:false;if(B){alert(f.outOfContainmentAlert);return false}var b={title:y[M].title,elements:[]};k.children(a?".fpd-editable":".fpd-element").each(function(e,d){var h={};g(d);h.title=g(d).attr("title");h.source=g(d).data("source");h.parameters=g(d).data("params");b.elements[e]=h});return b};this.addElement=function(a,b,e,d){if(typeof d!="object"){alert("The element "+e+" has not a valid JSON object as parameters!");
return false}if(k.children('div[title="'+e+'"]').size()>0&&a=="image")return false;d=g.extend({},parameters,d);var h=k.append('<div class="fpd-element"></div>').children("div:last").css({left:d.x,top:d.y,"z-index":k.children("div").size()-1}).attr("title",e).data("source",b).data("index",k.children("div").size()-1);d.source=b;d.originX=d.x;d.originY=d.y;if(d.colors){e=d.colors.replace(/\s+/g,"").split(",");d.colors=e;d.currentColor=e[0]}if(a=="image"){var l=new Image;l.src=b;l.onload=function(){if(d.colors.length>
0){var p=d.colors[0],s=document.createElement("canvas"),R=s.getContext("2d");s.width=this.width;s.height=this.height;R.drawImage(this,0,0);h.append(s);S(R,p)}else h.append(l);p=l.width*d.scale;s=l.height*d.scale;h.children("canvas, img").width(p).height(s).parent().css({width:p,height:s});d.colors.length>0||d.removable||d.draggable||d.resizable||d.rotatable?T(h):h.css("pointer-events","none");d.originWidth=p;d.originHeight=s;d.width=p;d.height=s;h.data("params",d);i.trigger("elementAdded",[h])}}else if(a==
"text"){var v=g('<input type="text" value="'+b+'" />');h.append(v).children("input:first").css({fontSize:f.textSize*d.scale,fontFamily:K,paddingTop:u.tb,paddingRight:u.lr,paddingBottom:u.tb,paddingLeft:u.lr}).autoGrowInput().keyup(function(){if(c){c.data("params").text=this.value;c.children("input").attr("value",this.value)}});setTimeout(function(){v.keyup()},200);d.colors.length>0&&v.css("color",d.colors[0]);T(h);d.text=d.source;d.font=K;d.textSize=f.textSize*d.scale;h.data("params",d);i.trigger("elementAdded",
[h])}else alert("Sorry. This type of element is not allowed!");if(d.price!=0){A+=d.price;i.trigger("priceChange",[d.price,A])}};this.addText=function(a){r.addElement("text",a,a,f.customTextParamters)};this.getPrice=function(){return A};this.print=function(){C();var a=window.open("print.html","","width="+k.width()+",height="+k.height()+"");g(a).load(function(){a.document.title=y[M].title;g(a.document.body).children("#fpd").append(k.html());g(a.document.body).find("canvas").each(function(b,e){var d=
g(e).parent().attr("title"),h=k.children('div[title="'+d+'"]'),l=h.children("canvas").get(0).getContext("2d");d=e.getContext("2d");h=h.data("params").currentColor;l=l.getImageData(0,0,l.canvas.width,l.canvas.height);for(var v=l.data,p=0;p<v.length;p+=4){v[p]=parseInt(D(h).substring(0,2),16);v[p+1]=parseInt(D(h).substring(2,4),16);v[p+2]=parseInt(D(h).substring(4,6),16)}d.putImageData(l,0,0)});setTimeout(a.print,1E3)})};this.clear=function(){C();k.children(".fpd-element").remove()};var U=function(a){if(a==
M)return false;Q=A=0;M=a;C();k.children(".fpd-element").remove();var b=g(y.get(a)).children("img, span");for(a=0;a<b.length;++a){var e=g(b[a]),d=e.data("parameters")==undefined?{}:e.data("parameters");r.addElement(e.is("img")?"image":"text",e.is("img")?e.attr("src"):e.text(),e.attr("title"),d)}i.bind("elementAdded",function(){++Q==b.length&&i.trigger("productCreate")})},T=function(a){a.addClass("fpd-editable").children("img, canvas, input").css("cursor","pointer").click(function(){C();var b=a.data("params");
w.show();if(a.children("input").size()>0){x.show();x.children('option[value="'+b.font+'"]').prop("selected","selected")}c=a.addClass("selected");b.removable&&c.append('<button title="Remove element" class="fpd-remove ui-state-default ui-corner-all"><span class="ui-icon ui-icon-trash"></span></button>').children(".fpd-remove ").click(function(){if(c.data("params").price!=0){A-=c.data("params").price;i.trigger("priceChange",[c.data("params").price,A])}g(this).parent().remove();C();return false});b.draggable&&
c.append('<button title="Drag element" class="fpd-drag ui-state-default ui-corner-all"><span class="ui-icon ui-icon-arrow-4"></span></button>').children(".fpd-drag").mousedown(function(){H=true;g(document).mouseup(function(){H=false;g(document).unbind("mouseup")});return false});b.resizable&&c.append('<button title="Resize element" class="fpd-resize ui-state-default ui-corner-all"><span class="ui-icon ui-icon-arrowthick-2-se-nw"></span></button>').children(".fpd-resize").mousedown(function(){I=true;
g(document).mouseup(function(){I=false;g(document).unbind("mouseup")});return false});b.rotatable&&c.append('<button title="Rotate element" class="fpd-rotate ui-state-default ui-corner-all"><span class="ui-icon ui-icon-arrowrefresh-1-e"></span></button>').children(".fpd-rotate").mousedown(function(){J=true;g(document).mouseup(function(){J=false;g(document).unbind("mouseup")});return false});if(b.colors){n.children("ul").empty();n.children("input").val(b.currentColor);if(b.colors.length>1){for(var e=
0;e<b.colors.length;++e)n.children("ul").append('<li style="background: '+b.colors[e]+';" data-color="'+b.colors[e]+'"></li>');n.children("ul").children("li").click(function(){var d=g(this).data("color");O(c,d)})}else n.children("input").ColorPickerSetColor(b.currentColor);n.children(".fpd-current-color").css("background",b.currentColor);n.show()}else n.hide();if(typeof b.boundingBox=="string"){e=k.children('div[title="'+b.boundingBox+'"]');b.boundingBox={x:e.position().left,y:e.position().top,width:e.width(),
height:e.height()}}if(typeof b.boundingBox=="object"){b=b.boundingBox;k.append('<div class="containment"></div>').children(".containment").css({left:b.x,top:b.y,width:b.width,height:b.height,"z-index":k.children("div").size()-1})}c.children("button").disableSelection().parent().css("z-index",k.children("div").size());f.editorMode&&V()})},O=function(a,b){if(a.children("input").size()>0)a.children("input").css("color",b);else{var e=a.children("canvas").get(0);S(e.getContext("2d"),b)}a.data("params").currentColor=
b;n.children("input").val(b);n.children(".fpd-current-color").css("background",b);n.children("input").ColorPickerSetColor(b)},S=function(a,b){for(var e=a.getImageData(0,0,a.canvas.width,a.canvas.height),d=e.data,h=0;h<d.length;h+=4){d[h]=parseInt(D(b).substring(0,2),16);d[h+1]=parseInt(D(b).substring(2,4),16);d[h+2]=parseInt(D(b).substring(4,6),16)}a.putImageData(e,0,0);a.canvas.fillStyle=b},C=function(){c&&c.css("z-index",c.data("index"));k.children("div").removeClass("selected").children("button").remove();
k.children("div.containment").remove();n.children("ul").stop().slideUp(0);n.hide();w.hide();x.hide();c=null;f.editorMode&&G.find("p > span:nth-child(2n)").text("")},P=function(a,b,e,d){var h=c.data("params").boundingBox,l=false;if(a<h.x)l=true;if(b<h.y)l=true;if(a+e>h.x+h.width)l=true;if(b+d>h.y+h.height)l=true;return l},V=function(){if(c){var a=c.data("params");G.children(".fpd-current-element").children("span:last").text(c.attr("title"));G.children(".fpd-position").children("span:last").text("x: "+
a.x+", y: "+a.y);G.children(".fpd-dimensions").children("span:last").text(a.width?"Width: "+a.width+"px, Height: "+a.height+"px":"Textsize: "+a.textSize+"px")}},D=function(a){return a.charAt(0)=="#"?a.substring(1,7):a};i.children("div:last").css("marginRight",0).trigger("ready");if(E){for(var o=0;o<y.length;++o){var L=g(y[o]);E.append('<li><img src="'+L.data("thumbnail")+'" title="'+L.attr("title")+'" /></li>')}E.children("li").click(function(){var a=E.find("li").index(g(this));c=null;U(a);return false})}if(F){for(o=
0;o<t.length;++o){L=g(t[o]);F.append('<li><img src="'+L.attr("src")+'" title="'+L.attr("title")+'" /></li>')}F.children("li").click(function(){var a=F.find("li").index(g(this));r.addElement("image",g(t[a]).attr("src"),t[a].title,g(t[a]).data("parameters"));return false})}n=w.children(".fpd-color-picker").children(".fpd-current-color").click(function(){c.data("params").colors.length>1?n.children("ul").stop().slideToggle(200):n.children("input").click()}).parent().children("input").ColorPicker({onSubmit:function(a,
b,e,d){g(d).ColorPickerHide();O(c,"#"+b)}}).parent();x=w.children(".fpd-fonts-dropdown").change(function(){c.data("params").font=this.value;c.children("input").css("font-family",this.value);setTimeout(function(){c.children("input").keyup()},200)});f.customTexts&&z.append('<button title="Add custom text">'+f.customTexts+"</button>").children("button:last").click(function(){r.addText(f.defaultCustomText);return false});if(q())return false;z.append('<div class="fpd-element-switcher clearfix"><button title="Select previous editable element" class="ui-state-default"><span class="ui-icon ui-icon-arrowthick-1-w"></span></button><button title="Select next editable element" class="ui-state-default"><span class="ui-icon ui-icon-arrowthick-1-e"></span></button></div>').find(".fpd-element-switcher > button:first").click(function(){if(c)c.prevAll(".fpd-editable:first").size()==
0?k.children(".fpd-editable:last").children("img, canvas, input").click():c.prevAll(".fpd-editable:first").children("img, canvas, input").click();else k.children(".fpd-editable:first").children("img, canvas, input").click();return false}).parent().children("button:last").click(function(){if(c)c.nextAll(".fpd-editable:first").size()==0?k.children(".fpd-editable:first").children("img, canvas, input").click():c.nextAll(".fpd-editable:first").children("img, canvas, input").click();else k.children(".fpd-editable:first").children("img, canvas, input").click();
return false});if(f.fonts.length>0&&f.fontDropdown){K=f.fonts[0];f.fonts.sort();for(o=0;o<f.fonts.length;++o)x.append('<option value="'+f.fonts[o]+'" style="font-family: '+f.fonts[o]+';">'+f.fonts[o]+"</option>");x.children('option[value="'+K+'"]').prop("selected","selected");x.show()}i.find(".fpd-scroll-up").click(function(){var a=g(this).next("div").children("ul"),b=parseInt(a.css("top"))+f.scrollAmount>0?Math.abs(parseInt(a.css("top"))):f.scrollAmount;parseInt(a.css("top"))<0&&a.is(":not(:animated)")&&
a.animate({top:"+="+b},200);return false});i.find(".fpd-scroll-down").click(function(){var a=g(this).parent().children("div"),b=a.children("ul"),e=Math.abs(parseInt(b.css("top")))+a.height()+f.scrollAmount<b.height()?-f.scrollAmount:Math.abs(parseInt(b.css("top")))+a.height()-b.height();Math.abs(parseInt(b.css("top")))+a.height()<b.height()&&b.is(":not(:animated)")&&b.animate({top:"+="+e},200);return false});w.children(".fpd-reset").click(function(){if(c){var a=c.data("params");c.css({left:a.originX,
top:a.originY,width:a.originWidth,height:a.originHeight});c.children("img, canvas").width(a.originWidth);c.children("input").css({fontSize:f.textSize*a.scale,fontFamily:K}).val(a.source).keyup();c.css("-moz-transform","rotate(0deg)");c.css("-webkit-transform","rotate(0deg)");c.css("-o-transform","rotate(0deg)");c.css("-ms-transform","rotate(0deg)");if(a.colors){O(c,a.colors[0]);a.currentColor=a.colors[0]}a.x=a.originX;a.y=a.originY;a.width=a.originWidth;a.height=a.originHeight;a.degree=0;c.data("params",
a);if(a.boundingBox)if(P(a.x,a.y,a.width,a.height)){i.trigger("elementOut");B=true}else{i.trigger("elementIn");B=false}}});w.children(".fpd-deselect").click(function(){C()});i.bind("elementOut",function(){c.append('<div class="fpd-warning"></div>').children("img, canvas, input").css("opacity",0.5)});i.bind("elementIn",function(){c.children("img, canvas, input").css("opacity",1);c.children(".fpd-warning").remove()});g(document).mousemove(function(a){if(c!=null){var b=c.offset();c.position();var e=
b.left+c.width()/2,d=b.top+c.height()/2,h=a.pageX,l=a.pageY;a=c.data("params");if(J){b=Math.atan2(h-e,l-d)*(180/Math.PI)*-1-130;c.css("-moz-transform","rotate("+b+"deg)");c.css("-webkit-transform","rotate("+b+"deg)");c.css("-o-transform","rotate("+b+"deg)");c.css("-ms-transform","rotate("+b+"deg)");a.degree=b}else if(H){c.css({left:"+="+(h-c.children(".fpd-drag").offset().left-4),top:"+="+(l-c.children(".fpd-drag").offset().top-4)});a.x=c.position().left;a.y=c.position().top}else if(I)if(c.children("img, canvas").size()>
0){b=h-b.left<f.minImageWidth?f.minImageWidth:h-b.left;if(b>f.maxImageWidth)b=f.maxImageWidth;e=Math.round(a.originHeight*(b/a.originWidth));c.children("img, canvas").css({width:b,height:e}).parent().width(b).height(e);a.width=b;a.height=e}else{b=l-b.top-20<f.minTextSize?f.minTextSize:l-b.top-20;if(b>f.maxTestSize)b=f.maxTestSize;c.children("input").css({"font-size":b}).keyup();a.textSize=b}if(a.boundingBox&&(J||H||I)){a=c.get(0).getBoundingClientRect().left-k.get(0).getBoundingClientRect().left-
1;d=c.get(0).getBoundingClientRect().top-k.get(0).getBoundingClientRect().top-1;b=c.get(0).getBoundingClientRect().width-3;e=c.get(0).getBoundingClientRect().height-2;if(c.children("input").size()>0){a+=u.lr;d+=u.tb;b-=u.lr*2;e-=u.tb*2}if(B!=P(a,d,b,e))if(P(a,d,b,e)){i.trigger("elementOut",[c]);B=true}else{i.trigger("elementIn",[c]);B=false}}if(f.editorMode&&(J||H||I))V()}});if(f.editorMode)G=i.append('<div class="fpd-editor-box"><h3>Editor Box</h3><p class="fpd-current-element"><span>Element: </span><span></span></p><p class="fpd-position"><span>Position: </span><span></span></p><p class="fpd-dimensions"><span>Dimensions: </span><span></span></p></div>').children(".fpd-editor-box");
U(0)};jQuery.fn.fancyProductDesigner=function(m){return this.each(function(){var j=g(this);if(!j.data("fancy-product-designer")){var f=new N(this,m);j.data("fancy-product-designer",f)}})};g.fn.fancyProductDesigner.defaults={minImageWidth:50,maxImageWidth:300,minTextSize:10,maxTestSize:50,textSize:18,scrollAmount:100,fontDropdown:true,fonts:["Arial","Helvetica","Times New Roman","Verdana","Geneva"],customTexts:"Add text",defaultCustomText:"Enter your text here",customTextParamters:{},editorMode:false,
canvasAlert:"Sorry! But your browser does not support HTML5 Canvas. Please update your browser!",outOfContainmentAlert:"An element is out of his containment. Please move it in his containment!"}})(jQuery);
(function(g){g.fn.autoGrowInput=function(q){q=g.extend({maxWidth:400,minWidth:10,comfortZone:0},q);this.filter("input:text").each(function(){var N=q.minWidth||g(this).width(),m="",j=g(this),f=g("<tester/>").css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:j.css("fontSize"),fontFamily:j.css("fontFamily"),fontWeight:j.css("fontWeight"),letterSpacing:j.css("letterSpacing"),whiteSpace:"nowrap"}),r=function(){f.css({"font-size":j.css("fontSize"),"font-family":j.css("fontFamily"),"font-weight":j.css("fontWeight"),
"letter-spacing":j.css("letterSpacing")});m=j.val();var i=m.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");f.html(i);i=f.width();j.width(i+q.comfortZone>=N?i+q.comfortZone:N).val(m)};f.insertAfter(j);g(this).bind("keyup keydown blur update",r);r()});return this}})(jQuery);
