/*
 * Fancy Product Designer v1.0.1
 *
 * Copyright 2011, Rafael Dery
 *
 */
 
(function(e){var q=function(q,r){var f=e.extend({},e.fn.fancyProductDesigner.defaults,r),p=this,g,C,k,L,v,s,w,y,m,x,D,t,J,Q=0,E=-1,M=0,c=null,u=0,F=!1,G=!1,H=!1,z=!1,K="Helvetica";g=e(q).addClass("fpd-container clearfix");m=g.children(".fpd-product").remove();x=g.children(".fpd-design, .fpd-motive").children("img, span");y=document.createElement("canvas");if(!Boolean(y.getContext&&y.getContext("2d")))return g.append('<div class="fpd-browser-alert"><p>'+f.canvasAlert+"</p></div>").children("div").append('<span><a href="http://www.mozilla.org/firefox/new/" title="Download Firefox" class="firefox"></a><a href="http://www.google.com/Chrome" title="Download Chrome" class="chrome"></a><a href="http://www.opera.com/download/" title="Download Opera" class="opera"></a></span>'), g.trigger("canvasFail"),!1;1<m.size()&&(C=g.append('<div class="fpd-product-selection"><a href="#" class="fpd-scroll-up ui-state-default"><span class="ui-icon ui-icon-carat-1-n"></span></a><div><ul></ul></div><a href="#" class="fpd-scroll-down ui-state-default"><span class="ui-icon ui-icon-carat-1-s"></span></a></div>').children(".fpd-product-selection").find("ul"));k=g.append('<div class="fpd-product-container"><div><div class="fpd-toolbar"></div></div><section class="clearfix"></section></div>').children(".fpd-product-container").children("div"); 0<x.size()&&(L=g.append('<div class="fpd-design-selection"><a href="#" class="fpd-scroll-up ui-state-default"><span class="ui-icon ui-icon-carat-1-n"></span></a><div><ul class="clearfix"></ul></div><a href="#" class="fpd-scroll-down ui-state-default"><span class="ui-icon ui-icon-carat-1-s"></span></a></div>').children(".fpd-design-selection").find("ul"),x.parent().remove());v=k.children(".fpd-toolbar").append('<div class="fpd-color-picker clearfix"><input type="text" value="" disabled="disabled" /></div><select class="fpd-fonts-dropdown"></select><div class="fpd-reset ui-state-default" title="Reset"><span class="ui-icon ui-icon-refresh"></span></div><div class="fpd-deselect ui-state-default" title="Deselect"><span class="ui-icon ui-icon-closethick"></span></div>'); y=k.parent().children("section");s=v.children(".fpd-color-picker");this.getProduct=function(a){onlyEditableElemets="undefined"!==typeof a?a:!1;if(z)return alert(f.outOfContainmentAlert),!1;if(0<k.children(".fpd-views").length){for(var b=[],c=k.children(".fpd-views").children("li"),d=0;d<c.length;++d){var h=c[d],n={title:e(h).children("img").attr("title"),elements:[]};if(void 0==e(h).data("elements"))e(t.get(d)).children("img, span").each(function(b,d){var c=e(d),h=e.extend({},f.elementParameters, c.data("parameters"));if(a){if(0<h.colors.length||h.removable||h.draggable||h.resizable||h.rotatable){var l={};l.title=c.attr("title");l.source=c.attr("src");l.parameters=h;n.elements[n.elements.length]=l}}else l={},l.title=c.attr("title"),l.source=c.attr("src"),l.parameters=h,n.elements[n.elements.length]=l});else if(a){var g=[];e(e(h).data("elements")).each(function(a,b){var d=b.parameters;(0<d.colors.length||d.removable||d.draggable||d.resizable||d.rotatable)&&g.push(b)});n.elements=g}else n.elements= e(h).data("elements");b.push(n)}return b}n={title:m[E].title,elements:[]};k.children(a?".fpd-editable":".fpd-element").each(function(a,b){var d={},c=e(b);d.title=c.attr("title");d.source=c.data("source");d.parameters=c.data("params");n.elements[a]=d});return n};this.addElement=function(a,b,l,d){if("object"!=typeof d)return alert("The element "+l+" has not a valid JSON object as parameters!"),!1;d=e.extend({},f.elementParameters,d);d.source=b;d.originX=d.x;d.originY=d.y;var h=k.append('<div class="fpd-element"></div>').children("div:last").css({left:d.x, top:d.y,"z-index":k.children("div").size()-1}).attr("title",l).data("source",b).attr("id",k.children(".fpd-element").size()-1);R(h,d.degree);if(d.colors&&"string"==typeof d.colors){var n=d.colors.replace(/\s+/g,"").split(",");d.colors=n;d.currentColor=n[0]}if("image"==a){var j=new Image;j.src=b;j.onload=function(){var a=d.width?d.width:j.width*d.scale,b=d.height?d.height:j.height*d.scale;if(0<d.colors.length){var c=d.currentColor,l=document.createElement("canvas"),f=l.getContext("2d");l.width=this.width; l.height=this.height;f.drawImage(this,0,0);h.append(l);S(f,c)}else h.append(j);h.children("canvas, img").width(a).height(b).parent().css({width:a,height:b});0<d.colors.length||d.removable||d.draggable||d.resizable||d.rotatable?T(h):h.css("pointer-events","none");d.originWidth=a;d.originHeight=b;d.width=a;d.height=b;h.data("params",d);g.trigger("elementAdded",[h])}}else if("text"==a){d.text=d.text?d.text:d.source;d.font=d.font?d.font:K;d.textSize=d.textSize?d.textSize:f.textSize*d.scale;var m=e('<input type="text" value="'+ d.text+'" />');h.append(m).children("input:first").css({fontSize:d.textSize,fontFamily:d.font,paddingTop:8,paddingRight:5,paddingBottom:8,paddingLeft:5}).autoGrowInput().keyup(function(){c&&(c.data("params").text=this.value,c.children("input").attr("value",this.value))});setTimeout(function(){m.keyup()},200);0<d.colors.length&&m.css("color",d.currentColor);T(h);h.data("params",d);g.trigger("elementAdded",[h])}else alert("Sorry. This type of element is not allowed!");d.price&&(u+=d.price,g.trigger("priceChange", [d.price,u]));0<t.size()&&(J.push({title:l,source:b,parameters:d}),e(k.children(".fpd-views").children("li").get(M)).data("elements",J))};this.addDesign=function(a,b,c){L.prepend("<li></li>").children("li:first").append('<img src="'+a+'" title="'+b+'" />').click(function(){var a=e(this).children("img");p.addElement("image",a.attr("src"),a.attr("title"),a.data("parameters"));return!1}).children("img").data("parameters",c)};this.getPrice=function(){return u};this.print=function(){A();var a=window.open("print.html", "","width="+k.width()+",height="+k.height()+"");e(a).load(function(){a.document.title=m[E].title;e(a.document.body).children("#fpd").append(k.html());e(a.document.body).find(".fpd-views").remove();e(a.document.body).find("canvas").each(function(a,c){for(var d=e(c).parent().attr("id"),h=k.children('div[id="'+d+'"]'),f=h.children("canvas").get(0).getContext("2d"),d=c.getContext("2d"),h=h.data("params").currentColor,f=f.getImageData(0,0,f.canvas.width,f.canvas.height),g=f.data,j=0;j<g.length;j+=4)g[j]= parseInt(B(h).substring(0,2),16),g[j+1]=parseInt(B(h).substring(2,4),16),g[j+2]=parseInt(B(h).substring(4,6),16);d.putImageData(f,0,0)});setTimeout(a.print,1E3)})};this.clear=function(){A();k.children(".fpd-element").remove()};var U=function(a){if(a==E)return!1;E=a;k.children(".fpd-views").remove();t=e(m.get(a)).children(".fpd-product");if(0<t.size()){t.splice(0,0,m.get(a));for(var b=k.append('<ul class="fpd-views clearfix"></ul>').children(".fpd-views"),c=0;c<t.length;++c){var d=e(t[c]);b.append('<li><img src="'+ d.data("thumbnail")+'" title="'+d.attr("title")+'" /></li>')}N(e(m.get(a)).children("img, span"));b.children("li").click(function(){var a=b.children("li").index(e(this));a!=M&&(M=a,N(void 0==e(b.children("li").get(a)).data("elements")?e(t.get(a)).children("img, span"):e(b.children("li").get(a)).data("elements")))})}else N(e(m.get(a)).children("img, span"))},N=function(a){J=[];Q=u=0;A();k.children(".fpd-element").remove();for(var b=0;b<a.length;++b){var c=e(a[b]);if(c.is("img,span")){var d=void 0== c.data("parameters")?{}:c.data("parameters");p.addElement(c.is("img")?"image":"text",c.is("img")?c.attr("src"):c.text(),c.attr("title"),d)}else p.addElement(void 0==a[b].parameters.text?"image":"text",a[b].parameters.source,a[b].title,a[b].parameters)}},T=function(a){a.addClass("fpd-editable").children("img, canvas, input").css("cursor","pointer").click(function(){A();var b=a.data("params");v.show();0<a.children("input").size()&&(w.show(),w.children('option[value="'+b.font+'"]').prop("selected","selected")); c=a.addClass("selected");b.removable&&c.append('<button title="Remove element" class="fpd-remove ui-state-default ui-corner-all"><span class="ui-icon ui-icon-trash"></span></button>').children(".fpd-remove ").hammer().bind("tap",function(){0!=c.data("params").price&&(u-=c.data("params").price,g.trigger("priceChange",[c.data("params").price,u]));J.splice(c.attr("id"),1);e(this).parent().remove();A();return!1});b.draggable&&(tempy=null,c.append('<button title="Drag element" class="fpd-drag ui-state-default ui-corner-all"><span class="ui-icon ui-icon-arrow-4"></span></button>').children(".fpd-drag").hammer({drag_min_distance:1}).bind("dragstart", function(){F=!0}));b.resizable&&c.append('<button title="Resize element" class="fpd-resize ui-state-default ui-corner-all"><span class="ui-icon ui-icon-arrowthick-2-se-nw"></span></button>').children(".fpd-resize").hammer({drag_min_distance:1}).bind("dragstart",function(){G=!0});b.rotatable&&c.append('<button title="Rotate element" class="fpd-rotate ui-state-default ui-corner-all"><span class="ui-icon ui-icon-arrowrefresh-1-e"></span></button>').children(".fpd-rotate").hammer({drag_min_distance:1}).bind("dragstart", function(){H=!0});b.colors?(s.children("input").val(b.currentColor),1<b.colors.length?s.children("input").spectrum("destroy").spectrum({preferredFormat:"hex",showPaletteOnly:!0,palette:b.colors,change:function(a){O(c,a.toHexString())}}):s.children("input").spectrum("destroy").spectrum({preferredFormat:"hex",showInput:!0,chooseText:"Change Color",change:function(a){O(c,a.toHexString())}}),s.show()):s.hide();if("string"==typeof b.boundingBox){var l=k.children('div[title="'+b.boundingBox+'"]');0<l.size()&& (b.boundingBox={x:l.position().left,y:l.position().top,width:l.width(),height:l.height()})}"object"==typeof b.boundingBox&&(b=b.boundingBox,k.append('<div class="containment"></div>').children(".containment").css({left:b.x,top:b.y,width:b.width,height:b.height,"z-index":k.children("div").size()-1}));c.children("button").disableSelection().parent().css("z-index",k.children("div").size());f.editorMode&&V()})},O=function(a,b){4==b.length&&(b+=b.substr(1,b.length));if(0<a.children("input").size())a.children("input").css("color", b);else{var c=a.children("canvas").get(0);S(c.getContext("2d"),b)}a.data("params").currentColor=b;s.children("input").spectrum("set",b)},S=function(a,b){for(var c=a.getImageData(0,0,a.canvas.width,a.canvas.height),d=c.data,f=0;f<d.length;f+=4)d[f]=parseInt(B(b).substring(0,2),16),d[f+1]=parseInt(B(b).substring(2,4),16),d[f+2]=parseInt(B(b).substring(4,6),16);a.putImageData(c,0,0);a.canvas.fillStyle=b},A=function(){c&&c.css("z-index",c.data("index"));k.children("div").removeClass("selected").children("button").remove(); k.children("div.containment").remove();s.hide();v.hide();w.hide();c=null;f.editorMode&&D.find("p > span:nth-child(2n)").text("")},P=function(a,b,f,d){var e=c.data("params").boundingBox,g=!1;a<e.x&&(g=!0);b<e.y&&(g=!0);a+f>e.x+e.width&&(g=!0);b+d>e.y+e.height&&(g=!0);return g},V=function(){if(c){var a=c.data("params");D.children(".fpd-current-element").children("span:last").text(c.attr("title"));D.children(".fpd-position").children("span:last").text("x: "+a.x+", y: "+a.y);D.children(".fpd-dimensions").children("span:last").text(a.width? "Width: "+a.width+"px, Height: "+a.height+"px":"Textsize: "+a.textSize+"px")}},R=function(a,b){a.css("-moz-transform","rotate("+b+"deg)");a.css("-webkit-transform","rotate("+b+"deg)");a.css("-o-transform","rotate("+b+"deg)");a.css("-ms-transform","rotate("+b+"deg)")},B=function(a){return"#"==a.charAt(0)?a.substring(1,7):a};g.children("div:last").css("marginRight",0).trigger("ready");if(C){for(var j=0;j<m.length;++j){var W=e(m[j]);C.append('<li><img src="'+W.data("thumbnail")+'" title="'+W.attr("title")+ '" /></li>')}C.children("li").click(function(){var a=C.find("li").index(e(this));c=null;U(a);return!1})}if(L)for(j=0;j<x.length;++j)p.addDesign(x[j].src,x[j].title,e(x[j]).data("parameters"));w=v.children(".fpd-fonts-dropdown").change(function(){c.data("params").font=this.value;c.children("input").css("font-family",this.value);setTimeout(function(){c.children("input").keyup()},200)});f.customTexts&&y.append('<button title="Add custom text">'+f.customTexts+"</button>").children("button:last").click(function(){p.addElement("text", f.defaultCustomText,f.defaultCustomText,f.customTextParamters);return!1});y.append('<div class="fpd-element-switcher clearfix"><button title="Select previous editable element" class="ui-state-default"><span class="ui-icon ui-icon-arrowthick-1-w"></span></button><button title="Select next editable element" class="ui-state-default"><span class="ui-icon ui-icon-arrowthick-1-e"></span></button></div>').find(".fpd-element-switcher > button:first").click(function(){c?0==c.prevAll(".fpd-editable:first").size()? k.children(".fpd-editable:last").children("img, canvas, input").click():c.prevAll(".fpd-editable:first").children("img, canvas, input").click():k.children(".fpd-editable:first").children("img, canvas, input").click();return!1}).parent().children("button:last").click(function(){c?0==c.nextAll(".fpd-editable:first").size()?k.children(".fpd-editable:first").children("img, canvas, input").click():c.nextAll(".fpd-editable:first").children("img, canvas, input").click():k.children(".fpd-editable:first").children("img, canvas, input").click(); return!1});if(0<f.fonts.length&&f.fontDropdown){K=f.fonts[0];f.fonts.sort();for(j=0;j<f.fonts.length;++j)w.append('<option value="'+f.fonts[j]+'" style="font-family: '+f.fonts[j]+';">'+f.fonts[j]+"</option>");w.children('option[value="'+K+'"]').prop("selected","selected");w.show()}g.find(".fpd-scroll-up").click(function(){var a=e(this).next("div").children("ul"),b=0<parseInt(a.css("top"))+f.scrollAmount?Math.abs(parseInt(a.css("top"))):f.scrollAmount;0>parseInt(a.css("top"))&&a.is(":not(:animated)")&& a.animate({top:"+="+b},200);return!1});g.find(".fpd-scroll-down").click(function(){var a=e(this).parent().children("div"),b=a.children("ul"),c=Math.abs(parseInt(b.css("top")))+a.height()+f.scrollAmount<b.height()?-f.scrollAmount:Math.abs(parseInt(b.css("top")))+a.height()-b.height();Math.abs(parseInt(b.css("top")))+a.height()<b.height()&&b.is(":not(:animated)")&&b.animate({top:"+="+c},200);return!1});v.children(".fpd-reset").click(function(){if(c){var a=c.data("params");c.css({left:a.originX,top:a.originY, width:a.originWidth,height:a.originHeight});c.children("img, canvas").width(a.originWidth).height(a.originHeight);c.children("input").css({fontSize:f.textSize*a.scale,fontFamily:K}).val(a.source).keyup();R(c,0);a.colors&&(O(c,a.colors[0]),a.currentColor=a.colors[0]);a.x=a.originX;a.y=a.originY;a.width=a.originWidth;a.height=a.originHeight;a.degree=0;c.data("params",a);a.boundingBox&&(P(a.x,a.y,a.width,a.height)?(g.trigger("elementOut"),z=!0):(g.trigger("elementIn"),z=!1))}});v.children(".fpd-deselect").click(function(){A()}); g.bind("elementAdded",function(){++Q==e(m.get(E)).children("img, span").size()&&g.trigger("productCreate")});g.bind("elementOut",function(){c.append('<div class="fpd-warning"></div>').children("img, canvas, input").css("opacity",0.5)});g.bind("elementIn",function(){c.children("img, canvas, input").css("opacity",1);c.children(".fpd-warning").remove()});k.hammer({drag_min_distance:1,hold_timeout:100}).bind("drag",function(a){if(null!=c){var b=c.offset();c.position();var e=b.left+c.width()/2,d=b.top+ c.height()/2,h=a.touches[0].x,j=a.touches[0].y;a=c.data("params");H?(b=-1*Math.atan2(h-e,j-d)*(180/Math.PI)-130,c.css("-moz-transform","rotate("+b+"deg)"),c.css("-webkit-transform","rotate("+b+"deg)"),c.css("-o-transform","rotate("+b+"deg)"),c.css("-ms-transform","rotate("+b+"deg)"),a.degree=b):G?0<c.children("img, canvas").size()?(b=h-b.left<f.minImageWidth?f.minImageWidth:h-b.left,b>f.maxImageWidth&&(b=f.maxImageWidth),e=Math.round(a.originHeight*(b/a.originWidth)),c.children("img, canvas").css({width:b, height:e}).parent().width(b).height(e),a.width=b,a.height=e):(b=j-b.top-20<f.minTextSize?f.minTextSize:j-b.top-20,b>f.maxTestSize&&(b=f.maxTestSize),c.children("input").css({"font-size":b}).keyup(),c.data("params").textSize=b):F&&(c.css({left:"+="+(h-c.children(".fpd-drag").offset().left-4),top:"+="+(j-c.children(".fpd-drag").offset().top-4)}),c.data("params").x=c.position().left,c.data("params").y=c.position().top);if(a.boundingBox&&(H||F||G))a=c.get(0).getBoundingClientRect().left-k.get(0).getBoundingClientRect().left- 1,d=c.get(0).getBoundingClientRect().top-k.get(0).getBoundingClientRect().top-1,b=c.get(0).getBoundingClientRect().width-3,e=c.get(0).getBoundingClientRect().height-2,0<c.children("input").size()&&(a+=5,d+=8,b-=10,e-=16),z!=P(a,d,b,e)&&(P(a,d,b,e)?(g.trigger("elementOut",[c]),z=!0):(g.trigger("elementIn",[c]),z=!1));f.editorMode&&(H||F||G)&&V()}}).bind("release",function(a){e(a.target).is("div")&&(H=G=F=!1)});f.editorMode&&(D=g.append('<div class="fpd-editor-box"><h3>Editor Box</h3><p class="fpd-current-element"><span>Element: </span><span></span></p><p class="fpd-position"><span>Position: </span><span></span></p><p class="fpd-dimensions"><span>Dimensions: </span><span></span></p></div>').children(".fpd-editor-box")); U(0)};jQuery.fn.fancyProductDesigner=function(I){return this.each(function(){var r=e(this);if(!r.data("fancy-product-designer")){var f=new q(this,I);r.data("fancy-product-designer",f)}})};e.fn.fancyProductDesigner.defaults={minImageWidth:50,maxImageWidth:300,minTextSize:10,maxTestSize:50,textSize:18,scrollAmount:100,fontDropdown:!0,fonts:["Arial","Helvetica","Times New Roman","Verdana","Geneva"],customTexts:"Add text",defaultCustomText:"Enter your text here",customTextParamters:{},editorMode:!1,canvasAlert:"Sorry! But your browser does not support HTML5 Canvas. Please update your browser!", outOfContainmentAlert:"An element is out of his containment. Please move it in his containment!",elementParameters:{x:0,y:0,colors:!1,removable:!1,draggable:!1,rotatable:!1,resizable:!1,scale:1,degree:0,price:0,boundingBox:!1}}})(jQuery); (function(e){e.fn.autoGrowInput=function(q){q=e.extend({maxWidth:400,minWidth:10,comfortZone:0},q);this.filter("input:text").each(function(){var I=q.minWidth||e(this).width(),r="",f=e(this),p=e("<tester/>").css({position:"absolute",top:-9999,left:-9999,width:"auto",fontSize:f.css("fontSize"),fontFamily:f.css("fontFamily"),fontWeight:f.css("fontWeight"),letterSpacing:f.css("letterSpacing"),whiteSpace:"nowrap"}),g=function(){p.css({"font-size":f.css("fontSize"),"font-family":f.css("fontFamily"),"font-weight":f.css("fontWeight"), "letter-spacing":f.css("letterSpacing")});r=f.val();var e=r.replace(/&/g,"&amp;").replace(/\s/g," ").replace(/</g,"&lt;").replace(/>/g,"&gt;");p.html(e);e=p.width();f.width(e+q.comfortZone>=I?e+q.comfortZone:I).val(r)};p.insertAfter(f);e(this).bind("keyup keydown blur update",g);g()});return this}})(jQuery);