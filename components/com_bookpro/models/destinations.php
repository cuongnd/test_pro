<?php/** * @package 	Bookpro * @author 		Nguyen Dinh Cuong * @link 		http://ibookingonline.com * @copyright 	Copyright (C) 2011 - 2012 Nguyen Dinh Cuong * @license 	GNU/GPLv3 http://www.gnu.org/licenses/gpl-3.0.html * @version 	$Id: airports.php 100 2012-08-29 14:55:21Z quannv $ **/defined('_JEXEC') or die('Restricted access');//import needed JoomLIB helpersAImporter::helper('request', 'model');jimport('joomla.application.component.modellist');class BookProModelDestinations extends JModelList{	/**	 * Main table	 *	 * @var TableCustomer	 */	public function __construct($config = array())	{		if (empty($config['dest_filter_fields'])) {			$config['dest_filter_fields'] = array(					'l.id',					'l.title',			);		}		parent::__construct($config);	}		protected function populateState($ordering = null, $direction = null)	{		parent::populateState();		$app = JFactory::getApplication();		$id = JRequest::getVar('id', 0, '', 'int');		$this->setState('airports.id', $id);					// Load the filter state.		$search = $this->getUserStateFromRequest('dest_filter_search', 'dest_filter_search');		$this->setState('dest_filter.search', $search);									$state = $this->getUserStateFromRequest('dest_filter_state', 'dest_filter_search');		$this->setState('dest_filter.state', $state);					$level = $this->getUserStateFromRequest('dest_filter_level', 'dest_filter_level', 0, 'int');		$this->setState('dest_filter.level', $level);				$country_id = $this->getUserStateFromRequest('dest_filter_country_id', 'dest_filter_country_id', 0, 'int');		$this->setState('dest_filter.country_id', $country_id);				$air = $this->getUserStateFromRequest('dest_filter_air', 'dest_filter_air', 0, 'int');		$this->setState('dest_filter.air', $air);				$app = JFactory::getApplication();		$value = $app->getUserStateFromRequest('global.list.limit', 'limit', $app->getCfg('list_limit'));		$limit = $value;		$this->setState('list.limit', $limit);					$value = $app->getUserStateFromRequest($this->context.'.limitstart', 'limitstart', 0);		$limitstart = ($limit != 0 ? (floor($value / $limit) * $limit) : 0);		$this->setState('list.start', $limitstart);					$value = $app->getUserStateFromRequest($this->context.'.ordercol', 'dest_filter_order', $ordering);		$this->setState('list.ordering', $value);		$value = $app->getUserStateFromRequest($this->context.'.orderdirn', 'dest_filter_order_Dir', $direction);		$this->setState('list.direction', $value);		parent::populateState('a.lft', 'asc');				}	/**	 * Get MySQL loading query for customers list	 *	 * @return string complet MySQL query	 */	protected function getListQuery()	{		$db = $this->getDbo();		$query = $db->getQuery(true);		$query->select('a.*,country.country_name AS country_name');		$query->from('#__bookpro_dest AS a');		$query->join('LEFT', '#__bookpro_country AS country ON country.id = a.country_id');		$query->join('INNER', '#__bookpro_flight AS flight ON a.id = flight.desfrom');				$query->where('parent_id <> 0');		if ($level = $this->getState('dest_filter.level'))		{			$query->where('a.level <= ' . (int) $level);		}		if($air = $this->getState('dest_filter.air')){			$query->where('a.air <= ' . (int) $air);		}				// Filter by access level.		if ($access = $this->getState('dest_filter.access'))		{			$query->where('a.access = ' . (int) $access);		}		$published = $this->getState('dest_filter.state');		if (is_numeric($published))		{			$query->where('a.state = ' . (int) $published);		}		elseif ($published === '')		{			$query->where('(a.state IN (0, 1))');		}		$listOrdering = $this->getState('list.ordering', 'a.lft');		$listDirn = $db->escape($this->getState('list.direction', 'ASC'));		if ($listOrdering == 'a.access')		{			$query->order('a.access ' . $listDirn . ', a.lft ' . $listDirn);		}		else		{			$query->order($db->escape($listOrdering) . ' ' . $listDirn);		}		$query->group('a.id');		//echo nl2br(str_replace('#__','jos_',$query));]v		return $query;	}	function getFullList(){		$dests = $this->getItems();		foreach ($dests as $dest){			$count = $this->countFlight($dest->id);			$dest->countFlight = $count;		}		return $dests;	}	function countFlight($from){		$db = JFactory::getDbo();		$query = $db->getQuery(true);		$query->select('count(flight.id)');		$query->from('#__bookpro_flight AS flight');		$query->where('flight.desfrom='.$from);		$db->setQuery($query);		return $db->loadResult();	}	function getDestinationByIds($Ids){		 		$query = 'SELECT `dest`.* FROM `' . $this->_table->getTableName() . '` AS `dest` ';		$query .= 'WHERE `dest`.`id` IN (' . implode(',', $Ids).')';		$this->_db->setQuery($query);		return  $this->_db->loadObjectList();	}	 	function getDestinationParents(){		$db = JFactory::getDbo();		$query = $db->getQuery(true);		$query->select('dest.*');		$query->from('#__bookpro_dest AS dest');		$query->where(array('dest.state=1','dest.parent_id=1'));				$db->setQuery($query);		$lists = $db->loadObjectList();				return $lists;	}	function getDestbyParent($parent_id){		$db = JFactory::getDbo();				if($parent_id){			$query = $db->getQuery(true);			$query->select('dest.*');			$query->from('#__bookpro_dest AS dest');			$query->where('dest.state=1');			$query->where('dest.parent_id='.$parent_id);			$db->setQuery($query);			$lists = $db->loadObjectList();		}else{			$lists = array();		}		return $lists;	}    function getFullDes(){        $db = JFactory::getDBO();        $query = $db->getQuery(true);        $query->select("*");        $query->from("#__bookpro_dest");        $db->setQuery($query);        $result = $db->loadObjectList();        return $result;    }	/**	 * Get MySQL filter criteria for customers list	 *	 * @return string filter criteria in MySQL format	 */		}?>